name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t go-redirect:test .

      - name: Start container
        run: |
          docker run -d --name redirect-test \
            -p 8080:8080 \
            -e REDIRECT_TARGET=https://example.com \
            -e PRESERVE_PATH=true \
            go-redirect:test
          sleep 2

      - name: Test health endpoint
        run: |
          curl -f http://localhost:8080/health | grep -q "OK"

      - name: Test redirect
        run: |
          LOCATION=$(curl -s -I http://localhost:8080/test/path | grep -i "^location:" | tr -d '\r')
          echo "Location: $LOCATION"
          echo "$LOCATION" | grep -q "https://example.com/test/path"

      - name: Test redirect code
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
          [ "$HTTP_CODE" = "301" ]

      - name: Cleanup
        if: always()
        run: |
          docker stop redirect-test || true
          docker rm redirect-test || true
